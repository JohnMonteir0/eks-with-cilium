name: "Terraform: Infrastructure Pipeline"

on:
  push:
    branches: [development, staging, main]
  workflow_dispatch:
    inputs:
      environment:
        description: "Select environment"
        required: true
        type: choice
        options:
          - development
          - staging
          - production

permissions:
  id-token: write
  contents: read
  issues: write

concurrency:
  group: "tf-${{ github.workflow }}-${{ github.ref_name }}"
  cancel-in-progress: false

jobs:
  plan:
    name: "Plan"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ github.ref_name == 'development' && secrets.DEV_AWS_ROLE_ARN || github.ref_name == 'staging' && secrets.STG_AWS_ROLE_ARN || secrets.PROD_AWS_ROLE_ARN }}
          aws-region: us-east-1
          role-session-name: gha-tf-plan-${{ github.run_id }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.9.6"

      - name: Init backend
        run: terraform init -reconfigure -upgrade -backend-config="backend/${{ github.ref_name == 'development' && 'dev' || github.ref_name == 'staging' && 'stg' || 'prod' }}.tfbackend"

      - name: Fmt
        run: terraform fmt -recursive

      - name: Validate
        run: terraform validate

      - name: Plan (binary + readable)
        run: |
          terraform plan -no-color -input=false -lock-timeout=2m \
            -var-file="envvars/${{ github.ref_name == 'development' && 'dev' || github.ref_name == 'staging' && 'stg' || 'prod' }}.tfvars" \
            -out=tfplan
          terraform show -no-color tfplan > tf-plan.out
          tail -n 500 tf-plan.out > tf-plan.tail.txt

      - name: Upload plan artifacts
        uses: actions/upload-artifact@v4
        with:
          name: "tfplan-${{ github.ref_name }}-${{ github.run_id }}"
          path: |
            tfplan
            tf-plan.out
            tf-plan.tail.txt
            backend/${{ github.ref_name == 'development' && 'dev' || github.ref_name == 'staging' && 'stg' || 'prod' }}.tfbackend

  approve:
    name: "Manual Approval "
    needs: plan
    runs-on: ubuntu-latest
    # For all branches
    if: ${{ github.ref_name == 'development' || github.ref_name == 'staging' || github.ref_name == 'main' }}
    steps:
      - name: Download plan tail
        uses: actions/download-artifact@v4
        with:
          name: "tfplan-${{ github.ref_name }}-${{ github.run_id }}"

      - name: Prepare plan body
        run: |
          {
            echo 'PLAN_BODY<<EOF'
            echo '```'
            sed -e 's/`/\\`/g' tf-plan.tail.txt
            echo '```'
            echo 'EOF'
          } >> "$GITHUB_ENV"

      - name: Await manual approval
        uses: trstringer/manual-approval@v1
        with:
          secret: ${{ secrets.GITHUB_TOKEN }}
          approvers: ${{ vars.APPROVERS || 'JohnMonteir0' }}
          minimum-approvals: ${{ vars.MIN_APPROVALS || 1 }}
          issue-title: "Approve apply: ${{ github.ref_name }} (run ${{ github.run_id }})"
          issue-body: |
            Plan for **${{ github.ref_name }}** is ready.
            **Branch/Commit:** ${{ github.ref }} / ${{ github.sha }}
            **Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

            **Plan (last ~500 lines):**
            ${{ env.PLAN_BODY }}

  apply:
    name: "Apply"
    needs: [plan, approve]
    runs-on: ubuntu-latest
    # Apply only after approval on all branches
    if: ${{ needs.approve.result == 'success' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ github.ref_name == 'development' && secrets.DEV_AWS_ROLE_ARN || github.ref_name == 'staging' && secrets.STG_AWS_ROLE_ARN || secrets.PROD_AWS_ROLE_ARN }}
          aws-region: us-east-1
          role-session-name: gha-tf-apply-${{ github.run_id }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.9.6"

      - name: Init backend
        run: terraform init -reconfigure -upgrade -backend-config="backend/${{ github.ref_name == 'development' && 'dev' || github.ref_name == 'staging' && 'stg' || 'prod' }}.tfbackend"

      - name: Download saved plan
        uses: actions/download-artifact@v4
        with:
          name: "tfplan-${{ github.ref_name }}-${{ github.run_id }}"

      - name: Apply saved plan
        run: terraform apply -no-color -input=false -lock-timeout=20m tfplan
